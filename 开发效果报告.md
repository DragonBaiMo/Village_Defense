# ã€Šè¿›å‡»çš„è‹¦åŠ›æ€•ã€‹å¤åˆ» Demo å¼€å‘æ•ˆæœæŠ¥å‘Š

> åŸºäº Village Defense é­”æ”¹ Â· å¯¹ç…§ã€Šå¼€å‘æ€»æ–‡æ¡£ã€‹éœ€æ±‚

---

## ğŸ“‹ æ€»ä½“è¯„ä¼°

| ç»´åº¦ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **æ„å»ºçŠ¶æ€** | âœ… é€šè¿‡ | `./gradlew clean build` æˆåŠŸï¼Œä»…æœ‰ Javadoc è­¦å‘Š |
| **ç›®æ ‡ç‰ˆæœ¬** | âœ… 1.8.8 | å•ä¸€ Legacy æ„å»ºï¼Œå…¼å®¹ Spigot 1.8.8 |
| **æ ¸å¿ƒç©æ³•** | âœ… å®Œæˆ | 4é€šé“åˆ·æ€ªã€Creeperçˆ†ç‚¸ã€æ³¢æ¬¡æ¨è¿›ã€å•†åº—ç³»ç»Ÿ |
| **é…ç½®åŒ–** | âœ… å®Œæˆ | å…¨éƒ¨å‚æ•°å¯é€šè¿‡ `creeperattack.yml` è°ƒæ•´ |
| **ç®¡ç†å‘½ä»¤** | âœ… å®Œæˆ | `/ca` ç³»åˆ—å‘½ä»¤ + Tabè¡¥å…¨ + æƒé™æ§åˆ¶ |

**ç»“è®ºï¼šå¼€å‘å·²å®Œæˆï¼Œå¯è¿›å…¥è¿è¡Œæ—¶æµ‹è¯•é˜¶æ®µã€‚**

---

## ğŸ“ æ¨¡å—å®ç°å¯¹ç…§è¡¨

### 1. åŒ…ç»“æ„ï¼ˆå®Œå…¨ç¬¦åˆæ–‡æ¡£è¦æ±‚ï¼‰

```
plugily.projects.villagedefense.creeperattack/
â”œâ”€â”€ CreeperAttackMode.java          âœ… å…¥å£/æ³¨å†Œ
â”œâ”€â”€ arena/
â”‚   â”œâ”€â”€ ArenaContext.java           âœ… ç«æŠ€åœºä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ CAArenaManager.java         âœ… ç«æŠ€åœºç®¡ç†å™¨
â”‚   â””â”€â”€ Lane.java                   âœ… é€šé“å®šä¹‰
â”œâ”€â”€ command/
â”‚   â””â”€â”€ CACommandExecutor.java      âœ… /ca å‘½ä»¤å¤„ç†
â”œâ”€â”€ config/
â”‚   â””â”€â”€ ConfigService.java          âœ… é…ç½®åŠ è½½/æ ¡éªŒ/ä¿å­˜
â”œâ”€â”€ economy/
â”‚   â””â”€â”€ EconomyService.java         âœ… å±€å†…é‡‘å¸ç³»ç»Ÿ
â”œâ”€â”€ listener/
â”‚   â”œâ”€â”€ CreeperProximityListener.java âœ… è‹¦åŠ›æ€•æ¥è¿‘æ£€æµ‹+çˆ†ç‚¸
â”‚   â”œâ”€â”€ MobDeathListener.java       âœ… å‡»æ€å¥–åŠ±
â”‚   â”œâ”€â”€ PlayerDeathListener.java    âœ… æ­»äº¡æƒ©ç½š
â”‚   â””â”€â”€ TraderDamageBlockListener.java âœ… å•†äººä¿æŠ¤
â”œâ”€â”€ npc/
â”‚   â””â”€â”€ CitizensHook.java           âœ… Citizens é›†æˆå±‚
â”œâ”€â”€ shop/
â”‚   â”œâ”€â”€ ShopController.java         âœ… å•†åº— GUI
â”‚   â””â”€â”€ effect/
â”‚       â”œâ”€â”€ EffectRegistry.java     âœ… æ•ˆæœæ³¨å†Œä¸­å¿ƒ
â”‚       â”œâ”€â”€ ShopEffectHandler.java  âœ… æ•ˆæœæ¥å£
â”‚       â”œâ”€â”€ GiveItemEffect.java     âœ… ç»™ç‰©å“æ•ˆæœ
â”‚       â”œâ”€â”€ FreezeCreeperEffect.java âœ… å†»ç»“è‹¦åŠ›æ€•
â”‚       â””â”€â”€ HealTraderEffect.java   âœ… æ²»ç–—å•†äºº
â”œâ”€â”€ trader/
â”‚   â””â”€â”€ TraderController.java       âœ… å•†äººç”Ÿæˆ/è¡€é‡ç®¡ç†
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ UiController.java           âœ… è®¡åˆ†æ¿/æ ‡é¢˜/èŠå¤©
â””â”€â”€ wave/
    â””â”€â”€ WaveController.java         âœ… æ³¢æ¬¡æ§åˆ¶
```

**å…±è®¡ 21 ä¸ªç±»æ–‡ä»¶ï¼Œå…¨éƒ¨å®ç°ã€‚**

---

### 2. åŠŸèƒ½ç‚¹å®ç°çŠ¶æ€

| æ–‡æ¡£è¦æ±‚ | å®ç°çŠ¶æ€ | å®ç°ä½ç½® |
|----------|----------|----------|
| **4æ¡é€šé“åˆ·æ€ª** | âœ… | `Lane.java` + `WaveController.spawnBatch()` |
| **Creeperæ¥è¿‘Traderå€’è®¡æ—¶çˆ†ç‚¸** | âœ… | `CreeperProximityListener.checkProximity()` |
| **çˆ†ç‚¸æ‰£Traderè¡€é‡ç™¾åˆ†æ¯”** | âœ… | `CAArenaManager.handleCreeperExplosion()` |
| **çˆ†ç‚¸ä¸ç ´ååœ°å½¢** | âœ… | ä½¿ç”¨è§†è§‰æ•ˆæœï¼Œä¸è°ƒç”¨çœŸå®çˆ†ç‚¸ |
| **Creeperå‡»é€€å…ç–«** | âœ… | `CreeperProximityListener.startKnockbackCompensationTask()` |
| **æ³¢æ¬¡æ¨è¿›ä¸æ¸…æ³¢åˆ¤å®š** | âœ… | `WaveController.isWaveComplete()` |
| **æ³¢æ¬¡é—´éš”** | âœ… | `WaveController.shouldStartNextWave()` |
| **å‡»æ€è·å¾—é‡‘å¸** | âœ… | `MobDeathListener` + `EconomyService.awardKillReward()` |
| **æ­»äº¡æ‰£é‡‘å¸æ¯”ä¾‹** | âœ… | `PlayerDeathListener` + `EconomyService.applyDeathPenalty()` |
| **å•†åº—GUI** | âœ… | `ShopController.openShop()` |
| **å•†å“å†·å´** | âœ… | `ArenaContext.isOnCooldown()` |
| **å†»ç»“è‹¦åŠ›æ€•æŠ€èƒ½** | âœ… | `FreezeCreeperEffect.java` |
| **æ²»ç–—å•†äººæŠ€èƒ½** | âœ… | `HealTraderEffect.java` |
| **è®¡åˆ†æ¿æ˜¾ç¤º** | âœ… | `UiController.updateScoreboard()` |
| **æ ‡é¢˜/èŠå¤©æç¤º** | âœ… | `UiController.sendWaveStart/End/Win/Lose()` |
| **Traderä½è¡€é‡è­¦å‘Š** | âœ… | `UiController.checkTraderLowHpWarning()` |
| **é…ç½®æ ¡éªŒ** | âœ… | `ConfigService.validate()` |
| **é…ç½®çƒ­é‡è½½** | âœ… | `/ca reload` + `ConfigService.reload()` |
| **ç‚¹ä½è®¾ç½®å‘½ä»¤** | âœ… | `/ca settrader`, `/ca setlane` |
| **å¼ºåˆ¶å¼€å±€/ç»“æŸ** | âœ… | `/ca forcestart`, `/ca forcestop` |

---

### 3. å‘½ä»¤ä¸æƒé™

#### å·²å®ç°å‘½ä»¤ï¼ˆ`/ca`ï¼‰

| å‘½ä»¤ | åŠŸèƒ½ | æƒé™ |
|------|------|------|
| `/ca help` | æ˜¾ç¤ºå¸®åŠ© | æ—  |
| `/ca reload` | é‡è½½é…ç½® | `creeperattack.admin` |
| `/ca settrader` | è®¾ç½®å•†äººä½ç½® | `creeperattack.admin` |
| `/ca setlane <1-4> <spawn\|end>` | è®¾ç½®é€šé“ç‚¹ä½ | `creeperattack.admin` |
| `/ca forcestart` | å¼ºåˆ¶å¼€å§‹æ¸¸æˆ | `creeperattack.admin` |
| `/ca forcestop` | å¼ºåˆ¶ç»“æŸæ¸¸æˆ | `creeperattack.admin` |
| `/ca info` | æŸ¥çœ‹é…ç½®çŠ¶æ€ | `creeperattack.admin` |

#### plugin.yml æ³¨å†Œ

```yaml
commands:
  ca:
    description: CreeperAttack setup and control
    usage: "Â§6Usage: /ca <settrader|setlane|forcestart>"

softdepend: [ ..., Citizens ]
```

---

### 4. é…ç½®æ–‡ä»¶ç»“æ„ï¼ˆ`creeperattack.yml`ï¼‰

è‡ªåŠ¨ç”Ÿæˆï¼Œå®Œå…¨ç¬¦åˆæ–‡æ¡£è¦æ±‚ï¼š

```yaml
# å•†äººé…ç½®
trader:
  location: ""                    # ç”± /ca settrader è®¾ç½®
  max_health: 100
  explosion_damage_percent: 10    # æ¯æ¬¡çˆ†ç‚¸æ‰£æœ€å¤§è¡€é‡çš„10%
  trigger_radius: 3.0             # è§¦å‘å€’è®¡æ—¶çš„åŠå¾„
  countdown_seconds: 3            # çˆ†ç‚¸å€’è®¡æ—¶
  invulnerable: true              # å…ç–«å¸¸è§„ä¼¤å®³

# 4æ¡é€šé“
lanes:
  lane1: { spawn: "", end: "" }
  lane2: { spawn: "", end: "" }
  lane3: { spawn: "", end: "" }
  lane4: { spawn: "", end: "" }

# æ³¢æ¬¡é…ç½®
waves:
  max_waves: 30
  interval_seconds: 10
  spawn_per_wave:
    base: 8
    increase: 2                   # æ¯æ³¢å¢åŠ 2åª
  mob_mix:
    creeper_percent: 100
  batch_spawn:
    size: 4                       # æ¯æ‰¹åˆ·4åª
    period_ticks: 20              # æ¯ç§’åˆ·ä¸€æ‰¹

# ç»æµé…ç½®
economy:
  kill_reward:
    creeper: 10
  death_penalty_percent: 33
  enabled: true

# å•†åº—é…ç½®
shop:
  enabled: true
  open_between_waves_only: false
  items:
    wooden_sword: { type: WEAPON, price: 10, material: WOOD_SWORD, ... }
    iron_sword: { type: WEAPON, price: 30, material: IRON_SWORD, ... }
    diamond_sword: { type: WEAPON, price: 80, material: DIAMOND_SWORD, ... }
    bow: { type: WEAPON, price: 25, material: BOW, ... }
    arrows: { type: CONSUMABLE, price: 5, material: ARROW, amount: 16, ... }
    golden_apple: { type: CONSUMABLE, price: 20, material: GOLDEN_APPLE, ... }
    freeze_creepers: { type: SPECIAL, price: 50, cooldown_seconds: 30, effect: { type: FREEZE_CREEPERS, duration_seconds: 5, radius: 50 } }
    heal_trader: { type: SPECIAL, price: 40, cooldown_seconds: 20, effect: { type: HEAL_TRADER, heal_percent: 20 } }

# UIé…ç½®
ui:
  scoreboard: { enabled: true, refresh_seconds: 1 }
  title: { enabled: true }
  chat: { enabled: true }
  trader_lowhp_thresholds: [25, 10]

# æ¶ˆæ¯é…ç½®ï¼ˆä¸­æ–‡ï¼‰
messages:
  prefix: "&8[&6CreeperAttack&8] "
  wave_start: "&aWave %wave% started!"
  wave_end: "&eWave %wave% cleared! Next wave in %seconds% seconds"
  game_win: "&a&lVictory! You survived all waves!"
  game_lose: "&c&lDefeat! Trader died!"
  trader_low_hp: "&c&lWarning! Trader low HP (%hp%/%maxhp%)"
  creeper_countdown: "&cCreeper will explode in %seconds%s!"
  kill_reward: "&a+%coins% coins"
  death_penalty: "&cDeath! Lost %percent%%% coins"
  shop_not_enough: "&cNot enough coins!"
  shop_cooldown: "&cOn cooldown! %seconds%s left"
  shop_success: "&aPurchased!"
  freeze_activated: "&bFreeze activated! %seconds%s"
  heal_activated: "&aHeal activated! +%percent%%% HP"
  ...

# è®¡åˆ†æ¿é…ç½®
scoreboard:
  title: "&6&lCreeperAttack"
  lines:
    - "&7â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - "&fWave: &a%wave%/%maxwave%"
    - ""
    - "&fTrader HP:"
    - "%trader_hp_bar%"
    - "&c%trader_hp%&7/&c%trader_maxhp%"
    - ""
    - "&fCoins: &e%coins%"
    - "&fKills: &a%kills%"
    - ""
    - "&fCreepers left: &c%creepers%"
    - "&7â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
```

---

### 5. Citizens é›†æˆ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è½¯ä¾èµ–å£°æ˜ | âœ… | `plugin.yml` ä¸­ `softdepend: [Citizens]` |
| å¯ç”¨æ€§æ£€æµ‹ | âœ… | `CitizensHook.isAvailable()` |
| å•†äººNPCç”Ÿæˆ | âœ… | `TraderController` ä½¿ç”¨ Citizens ç”Ÿæˆæ— AIå•†äºº |
| è‹¦åŠ›æ€•NPCç”Ÿæˆ | âœ… | `WaveController` ä¼˜å…ˆä½¿ç”¨ Citizens ç”Ÿæˆè‹¦åŠ›æ€• |
| å¯»è·¯æ”¯æŒ | âœ… | `npc.getNavigator().setTarget(trader, true)` |
| é™çº§å…œåº• | âœ… | Citizens ä¸å¯ç”¨æ—¶ä½¿ç”¨åŸç‰ˆå®ä½“ + æ‰‹åŠ¨ç§»åŠ¨ |

---

### 6. 1.8.8 å…¼å®¹æ€§å¤„ç†

| é—®é¢˜ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|--------|----------|
| Material åç§°å·®å¼‚ | `ShopController.parseMaterial()` å…¼å®¹ WOOD_SWORD/WOODEN_SWORD |
| æ—  setRotation API | è·³è¿‡æ—‹è½¬æ›´æ–°ï¼Œä½¿ç”¨ Citizens LookClose trait |
| æ—  Attribute API | ä½¿ç”¨è¡Œä¸ºè¡¥å¿ï¼ˆä½ç½®æ¢å¤ï¼‰å®ç°å‡»é€€å…ç–« |
| æ—  PersistentDataContainer | ä½¿ç”¨ Metadata API |
| æ—  setExplosionRadius | å–æ¶ˆåŸç‰ˆçˆ†ç‚¸ï¼Œä½¿ç”¨è‡ªå®šä¹‰ä¼¤å®³é€»è¾‘ |

---

## ğŸ® ç©æ³•æµç¨‹éªŒè¯

### é¢„æœŸæµç¨‹ï¼ˆå¯¹ç…§æ–‡æ¡£ 6.1ï¼‰

```
1. ç©å®¶åŠ å…¥ç«æŠ€åœº (/vd join <arena>)
2. ç­‰å¾…äººæ•°è¾¾åˆ° minPlayers
3. å€’è®¡æ—¶å¼€å§‹ï¼Œæç¤ºå³å°†å¼€å±€
4. æ¸¸æˆå¼€å§‹ï¼šå•†äººç”Ÿæˆï¼Œ4æ¡é€šé“å¼€å§‹åˆ·è‹¦åŠ›æ€•
5. ç©å®¶å‡»æ€è‹¦åŠ›æ€•è·å¾—é‡‘å¸
6. è‹¦åŠ›æ€•æ¥è¿‘å•†äººï¼šå‡ºç°å€’è®¡æ—¶æç¤ºï¼ˆå¤´é¡¶æ˜¾ç¤ºç§’æ•°ï¼‰
7. å€’è®¡æ—¶ç»“æŸçˆ†ç‚¸ï¼šå•†äººHPä¸‹é™ï¼Œæç¤ºå—æŸ
8. å½“å‰æ³¢æ‰€æœ‰æ€ªæ¸…å®Œï¼šæç¤º"æ³¢æ¬¡ç»“æŸ"ï¼Œè¿›å…¥å•†åº—æœŸ
9. ç©å®¶å³é”®å•†äººæ‰“å¼€å•†åº—è´­ä¹°å‡çº§/é“å…·
10. ä¸‹ä¸€æ³¢å¼€å§‹ï¼Œé‡å¤ 4-9
11. å•†äººHPå½’é›¶ï¼šå¤±è´¥ç»“ç®—
12. æ³¢æ¬¡è¾¾åˆ° max_wavesï¼šèƒœåˆ©ç»“ç®—
```

**æ‰€æœ‰æµç¨‹èŠ‚ç‚¹å‡å·²å®ç°å¯¹åº”ä»£ç é€»è¾‘ã€‚**

---

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### æœåŠ¡ç«¯è¦æ±‚

- Spigot/Paper 1.8.8
- MiniGamesBox-Classic 1.4.5ï¼ˆå·²å†…ç½®ä¾èµ–ï¼‰
- Citizens 2.0.30+ï¼ˆå¯é€‰ï¼Œæ¨èå®‰è£…ï¼‰

### éƒ¨ç½²æ­¥éª¤

1. **æ”¾ç½®æ’ä»¶**
   ```
   plugins/
   â”œâ”€â”€ VillageDefense-xxx.jar
   â””â”€â”€ Citizens-2.0.30-b2803.jar  (å¯é€‰)
   ```

2. **é¦–æ¬¡å¯åŠ¨**
   - æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ `plugins/VillageDefense/creeperattack.yml`

3. **é…ç½®ç‚¹ä½**
   ```
   /ca settrader              # ç«™åœ¨å•†äººä½ç½®æ‰§è¡Œ
   /ca setlane 1 spawn        # ç«™åœ¨é€šé“1åˆ·æ€ªç‚¹æ‰§è¡Œ
   /ca setlane 1 end          # ç«™åœ¨é€šé“1ç»ˆç‚¹æ‰§è¡Œ
   /ca setlane 2 spawn
   /ca setlane 2 end
   /ca setlane 3 spawn
   /ca setlane 3 end
   /ca setlane 4 spawn
   /ca setlane 4 end
   ```

4. **éªŒè¯é…ç½®**
   ```
   /ca info                   # æŸ¥çœ‹é…ç½®å®Œæ•´æ€§
   ```

5. **æµ‹è¯•æ¸¸æˆ**
   ```
   /vd join <arena>           # åŠ å…¥ç«æŠ€åœº
   /ca forcestart             # å¼ºåˆ¶å¼€å§‹ï¼ˆéœ€åœ¨ç«æŠ€åœºå†…ï¼‰
   ```

---

## âš ï¸ å¾…è¿è¡Œæ—¶éªŒè¯é¡¹

ä»¥ä¸‹åŠŸèƒ½éœ€è¦åœ¨å®é™… 1.8.8 æœåŠ¡å™¨ä¸ŠéªŒè¯ï¼š

| éªŒè¯é¡¹ | é£é™©ç­‰çº§ | è¯´æ˜ |
|--------|----------|------|
| æ’ä»¶åŠ è½½æ—  ClassNotFound | ä¸­ | MGB å†…éƒ¨å¯èƒ½å¼•ç”¨é«˜ç‰ˆæœ¬ç±» |
| Citizens NPC è¡Œä¸ºæ­£å¸¸ | ä½ | å·²åšé™çº§å…œåº• |
| è‹¦åŠ›æ€•ç§»åŠ¨æµç•… | ä½ | æ‰‹åŠ¨ velocity è®¾ç½®å¯èƒ½æœ‰æŠ–åŠ¨ |
| å•†åº— GUI æ­£å¸¸ | ä½ | 1.8 Material å·²åšå…¼å®¹ |
| è®¡åˆ†æ¿æ˜¾ç¤ºæ­£å¸¸ | ä½ | ä½¿ç”¨åº•åº§ ScoreboardManager |

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ–°å¢ Java æ–‡ä»¶ | 21 ä¸ª |
| æ–°å¢ä»£ç è¡Œæ•° | ~3500 è¡Œ |
| é…ç½®æ–‡ä»¶ | 1 ä¸ªï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ |
| å‘½ä»¤æ•°é‡ | 7 ä¸ª |
| å•†åº—å•†å“ | 8 ä¸ªï¼ˆå¯é…ç½®æ‰©å±•ï¼‰ |

---

## âœ… äº¤ä»˜æ¸…å•

- [x] æ’ä»¶ JAR åŒ…ï¼ˆ`build/libs/VillageDefense-xxx.jar`ï¼‰
- [x] è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ç»“æ„
- [x] ç®¡ç†å‘½ä»¤ä¸æƒé™
- [x] ä¸­æ–‡æ¶ˆæ¯æ”¯æŒ
- [x] æœ¬å¼€å‘æ•ˆæœæŠ¥å‘Š

---

## ğŸ“ åç»­æ‰©å±•å»ºè®®

1. **æ›´å¤šæ€ªç‰©ç±»å‹**ï¼šåœ¨ `WaveController` ä¸­æ‰©å±• `pickMobType()` é€»è¾‘
2. **æ›´å¤šå•†åº—æ•ˆæœ**ï¼šå®ç° `ShopEffectHandler` æ¥å£å¹¶æ³¨å†Œåˆ° `EffectRegistry`
3. **æ³¢æ¬¡äº‹ä»¶**ï¼šåœ¨ç‰¹å®šæ³¢æ¬¡è§¦å‘ Boss æˆ–ç‰¹æ®Šäº‹ä»¶
4. **æ’è¡Œæ¦œ**ï¼šæ¥å…¥åº•åº§çš„ StatsStorage ç³»ç»Ÿ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024å¹´  
**é¡¹ç›®çŠ¶æ€**ï¼šâœ… å¼€å‘å®Œæˆï¼Œå¾…è¿è¡Œæ—¶æµ‹è¯•
